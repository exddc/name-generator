services:
  redis:
    image: bitnami/redis:latest
    profiles: [infra]
    environment:
      - ALLOW_EMPTY_PASSWORD=yes
    ports:
      - "${REDIS_PORT:-6379}:6379"
    volumes:
      - redis-data:/bitnami/redis/data
    restart: unless-stopped
    networks:
      - domain-generator-network

  postgres:
    image: postgres:18
    profiles: [infra]
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-password}
      POSTGRES_DB: ${POSTGRES_DB:-domain_generator}
      POSTGRES_PORT: ${POSTGRES_PORT:-5432}
    volumes:
       - postgres-data:/var/lib/postgresql
    ports:
      - "${POSTGRES_HOST_PORT:-5432}:5432"
    networks:
      - domain-generator-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-postgres} -d ${POSTGRES_DB:-domain_generator}"]
      interval: 10s
      timeout: 5s
      retries: 5

  worker:
    build:
      context: ./apps/worker
    profiles: [backend]
    environment:
      REDIS_URL: ${REDIS_URL:-redis://redis:6379/0}
    depends_on:
      redis:
        condition: service_started
    networks:
      - domain-generator-network
    restart: unless-stopped
    deploy:
      replicas: ${WORKER_REPLICAS:-1}

  api:
    build:
      context: ./apps/api
    profiles: [backend]
    ports:
      - "${API_PORT:-8000}:8000"
    environment:
      REDIS_URL: ${REDIS_URL:-redis://redis:6379/0}
      POSTGRES_HOST: postgres
      GROQ_API_KEY: ${GROQ_API_KEY}
      API_JWT_SECRET: ${API_JWT_SECRET}
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_started
    networks:
      - domain-generator-network
    restart: unless-stopped

  web:
    build:
      context: ./apps/web
      args:
        NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL:-http://localhost:8000}
        BETTER_AUTH_URL: ${BETTER_AUTH_URL:-http://localhost:3000}
        NEXT_PUBLIC_BETTER_AUTH_URL: ${NEXT_PUBLIC_BETTER_AUTH_URL:-http://localhost:3000}
        BETTER_AUTH_SECRET: ${BETTER_AUTH_SECRET:-local-dev-secret}
        API_JWT_SECRET: ${API_JWT_SECRET:-please-change-me}
        API_JWT_ISSUER: ${API_JWT_ISSUER:-domain-generator-web}
        API_JWT_AUDIENCE: ${API_JWT_AUDIENCE:-domain-generator-api}
        API_JWT_ALGORITHM: ${API_JWT_ALGORITHM:-HS256}
        PORT: ${WEB_PORT:-3000}
    profiles: [frontend]
    environment:
      NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL:-http://localhost:8000}
      BETTER_AUTH_URL: ${BETTER_AUTH_URL:-http://localhost:3000}
      NEXT_PUBLIC_BETTER_AUTH_URL: ${NEXT_PUBLIC_BETTER_AUTH_URL:-http://localhost:3000}
      BETTER_AUTH_SECRET: ${BETTER_AUTH_SECRET:-local-dev-secret}
      RESEND_API_KEY: ${RESEND_API_KEY:-}
      RESEND_FROM_EMAIL: ${RESEND_FROM_EMAIL:-}
      API_JWT_SECRET: ${API_JWT_SECRET:-please-change-me}
      API_JWT_ISSUER: ${API_JWT_ISSUER:-domain-generator-web}
      API_JWT_AUDIENCE: ${API_JWT_AUDIENCE:-domain-generator-api}
      API_JWT_ALGORITHM: ${API_JWT_ALGORITHM:-HS256}
      POSTGRES_HOST: ${POSTGRES_HOST:-postgres}
      POSTGRES_PORT: ${POSTGRES_PORT:-5432}
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-password}
      POSTGRES_DB: ${POSTGRES_DB:-domain_generator}
      PORT: ${WEB_PORT:-3000}
    depends_on:
      api:
        condition: service_started
    ports:
      - "${WEB_PORT:-3000}:3000"
    networks:
      - domain-generator-network
    restart: unless-stopped

networks:
  domain-generator-network:
    driver: bridge

volumes:
  redis-data:
  postgres-data: